name: Setup Created Discussions

on:
  discussion:
    types:
      - created

jobs:
  label_discussion:
    runs-on: ubuntu-latest
    permissions:
      discussions: write
      contents: read

    steps:
      - name: Set labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { discussion, repository } = context.payload;
            const author = discussion.user.login;

            const feTeam = ['keemsebin', 'ExceptAnyone', 'yeji0214'];
            const beTeam = ['joon6093', 'abc5259', 'praisebak', 'jumdo12'];

            const LABELS = {
              be: 'LA_kwDOPIGZA88AAAACE1Y_wg',
              fe: 'LA_kwDOPIGZA88AAAACE1ZRBg'
            };

            let labelNodeId = null;
            if (feTeam.includes(author)) labelNodeId = LABELS.fe;
            else if (beTeam.includes(author)) labelNodeId = LABELS.be;

            if (!labelNodeId) return;

            await github.graphql(`
              mutation($discussionId: ID!, $labelIds: [ID!]!) {
                addLabelsToLabelable(input: {
                  labelableId: $discussionId,
                  labelIds: $labelIds
                }) {
                  clientMutationId
                }
              }
            `, {
              discussionId: discussion.node_id,
              labelIds: [labelNodeId]
            });

      - name: Send notification
        env:
          SLACK_WEBHOOK_URL_DISCUSSION: ${{ secrets.SLACK_WEBHOOK_URL_DISCUSSION }}
        run: |
          AUTHOR="${{ github.event.discussion.user.login }}"
          TITLE="${{ github.event.discussion.title }}"
          URL="${{ github.event.discussion.html_url }}"

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ğŸ’¬ *ìƒˆë¡œìš´ Discussionì´ ì—´ë ¸ìŠµë‹ˆë‹¤!*\ní•œ ì¤„ì´ë¼ë„ ì¢‹ì•„ìš”. í•¨ê»˜ ê¸°ë¡í•˜ê³ , í•¨ê»˜ ë§Œë“¤ì–´ê°€ìš” :sparkles:\n\n*ì‘ì„±ì:* ${AUTHOR}\n*ì œëª©:* ${TITLE}\nğŸ‘‰ <${URL}|ì§€ê¸ˆ í™•ì¸í•˜ê¸°>\"
            }" \
            $SLACK_WEBHOOK_URL_DISCUSSION
